#!/bin/bash
#
# Pre-commit hook for VisionClaw
# Runs SwiftLint on staged Swift files
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ” Running pre-commit checks..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Check if SwiftLint is installed
if ! command -v swiftlint &> /dev/null; then
    echo -e "${YELLOW}âš ï¸  SwiftLint not installed${NC}"
    echo ""
    echo "Install with: brew install swiftlint"
    echo ""
    echo "Skipping lint check (install SwiftLint to enable)"
    echo ""
    exit 0
fi

# Get list of staged Swift files
SWIFT_FILES=$(git diff --cached --name-only --diff-filter=d | grep "\.swift$" | grep -v "samples/CameraAccess/CameraAccessTests" || true)

if [ -z "$SWIFT_FILES" ]; then
    echo -e "${GREEN}âœ… No Swift files staged for commit${NC}"
    echo ""
    exit 0
fi

echo "ğŸ“ Staged Swift files:"
echo "$SWIFT_FILES" | sed 's/^/  - /'
echo ""

# Run SwiftLint on staged files
echo "ğŸ” Running SwiftLint..."
echo ""

LINT_ERRORS=0
for file in $SWIFT_FILES; do
    if [ -f "$file" ]; then
        # Lint the file
        if ! swiftlint lint --path "$file" --quiet; then
            LINT_ERRORS=$((LINT_ERRORS + 1))
        fi
    fi
done

echo ""

if [ $LINT_ERRORS -gt 0 ]; then
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${RED}âŒ SwiftLint found $LINT_ERRORS issue(s)${NC}"
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "Fix the issues above, or:"
    echo "  â€¢ Run 'swiftlint autocorrect' to auto-fix some issues"
    echo "  â€¢ Use 'git commit --no-verify' to bypass (not recommended)"
    echo ""
    exit 1
fi

echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}âœ… All pre-commit checks passed!${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

exit 0
